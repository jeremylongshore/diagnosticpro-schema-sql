{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://diagnosticpro.com/schemas/feature_store.json",
  "title": "Feature Store",
  "description": "ML feature storage and versioning schema",
  "type": "object",
  "required": [
    "feature_date",
    "entity_id",
    "entity_type",
    "feature_set_name",
    "feature_set_version"
  ],
  "properties": {
    "feature_date": {
      "type": "string",
      "format": "date",
      "description": "Date when features were computed (used for partitioning)"
    },
    "entity_id": {
      "type": "string",
      "pattern": "^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$",
      "description": "UUID of the entity (equipment, user, session, part)"
    },
    "entity_type": {
      "type": "string",
      "enum": ["equipment", "user", "session", "part"],
      "description": "Type of entity the features belong to"
    },
    "feature_set_name": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9_]*$",
      "maxLength": 100,
      "description": "Feature set name in snake_case format"
    },
    "feature_set_version": {
      "type": "string",
      "pattern": "^v?\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version of the feature set"
    },
    "feature_group": {
      "type": ["string", "null"],
      "enum": [
        "behavioral",
        "statistical",
        "temporal",
        "geographic",
        "technical",
        "financial",
        "operational",
        "diagnostic",
        "maintenance",
        "usage_patterns",
        "performance_metrics",
        "sensor_derived",
        "text_features",
        "image_features"
      ],
      "description": "Feature group classification"
    },
    "features": {
      "type": "object",
      "patternProperties": {
        "^[a-z][a-z0-9_]*$": {
          "oneOf": [
            {"type": "number"},
            {"type": "string"},
            {"type": "boolean"},
            {"type": "null"},
            {
              "type": "array",
              "items": {
                "oneOf": [
                  {"type": "number"},
                  {"type": "string"},
                  {"type": "boolean"}
                ]
              }
            }
          ]
        }
      },
      "additionalProperties": false,
      "description": "Feature values as key-value pairs (snake_case keys only)"
    },
    "feature_metadata": {
      "type": "object",
      "properties": {
        "computation_timestamp": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "When features were computed"
        },
        "computation_duration_ms": {
          "type": ["integer", "null"],
          "minimum": 0,
          "description": "Time taken to compute features in milliseconds"
        },
        "feature_count": {
          "type": ["integer", "null"],
          "minimum": 0,
          "description": "Number of features in this record"
        },
        "source_data_version": {
          "type": ["string", "null"],
          "maxLength": 50,
          "description": "Version of source data used"
        },
        "pipeline_version": {
          "type": ["string", "null"],
          "maxLength": 50,
          "description": "Version of feature pipeline"
        },
        "dependencies": {
          "type": "array",
          "items": {
            "type": "string",
            "maxLength": 100
          },
          "description": "Dependencies required for feature computation"
        }
      },
      "additionalProperties": false
    },
    "data_quality": {
      "type": "object",
      "properties": {
        "completeness_score": {
          "type": ["number", "null"],
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Data completeness score (0-1)"
        },
        "freshness_hours": {
          "type": ["integer", "null"],
          "minimum": 0,
          "maximum": 8760,
          "description": "Data freshness in hours (max 1 year)"
        },
        "accuracy_score": {
          "type": ["number", "null"],
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Data accuracy score (0-1)"
        },
        "consistency_score": {
          "type": ["number", "null"],
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Data consistency score (0-1)"
        },
        "null_count": {
          "type": ["integer", "null"],
          "minimum": 0,
          "description": "Number of null/missing feature values"
        },
        "outlier_count": {
          "type": ["integer", "null"],
          "minimum": 0,
          "description": "Number of outlier feature values detected"
        },
        "validation_status": {
          "type": ["string", "null"],
          "enum": ["passed", "failed", "warning", "not_validated"],
          "description": "Feature validation status"
        },
        "validation_errors": {
          "type": "array",
          "items": {
            "type": "string",
            "maxLength": 200
          },
          "description": "Validation errors encountered"
        }
      },
      "additionalProperties": false
    },
    "statistical_summary": {
      "type": "object",
      "properties": {
        "mean_values": {
          "type": ["object", "null"],
          "description": "Mean values for numerical features"
        },
        "std_values": {
          "type": ["object", "null"],
          "description": "Standard deviation for numerical features"
        },
        "min_values": {
          "type": ["object", "null"],
          "description": "Minimum values for numerical features"
        },
        "max_values": {
          "type": ["object", "null"],
          "description": "Maximum values for numerical features"
        },
        "categorical_counts": {
          "type": ["object", "null"],
          "description": "Value counts for categorical features"
        },
        "correlation_matrix": {
          "type": ["object", "null"],
          "description": "Feature correlation matrix"
        }
      },
      "additionalProperties": false
    },
    "lineage": {
      "type": "object",
      "properties": {
        "source_tables": {
          "type": "array",
          "items": {
            "type": "string",
            "maxLength": 200
          },
          "description": "Source tables used for feature computation"
        },
        "transformation_steps": {
          "type": "array",
          "items": {
            "type": "string",
            "maxLength": 300
          },
          "description": "Data transformation steps applied"
        },
        "feature_engineering_methods": {
          "type": "array",
          "items": {
            "type": "string",
            "maxLength": 100
          },
          "description": "Feature engineering methods used"
        },
        "aggregation_windows": {
          "type": ["object", "null"],
          "description": "Time windows used for aggregations"
        },
        "parent_feature_sets": {
          "type": "array",
          "items": {
            "type": "string",
            "maxLength": 100
          },
          "description": "Parent feature sets this depends on"
        }
      },
      "additionalProperties": false
    },
    "usage_tracking": {
      "type": "object",
      "properties": {
        "models_using": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$"
          },
          "description": "Model IDs that use these features"
        },
        "last_accessed": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "When features were last accessed"
        },
        "access_count": {
          "type": ["integer", "null"],
          "minimum": 0,
          "description": "Number of times features have been accessed"
        },
        "performance_impact": {
          "type": ["object", "null"],
          "description": "Performance impact metrics"
        }
      },
      "additionalProperties": false
    },
    "retention_policy": {
      "type": "object",
      "properties": {
        "retention_days": {
          "type": ["integer", "null"],
          "minimum": 1,
          "maximum": 3650,
          "description": "Retention period in days (max 10 years)"
        },
        "archive_after_days": {
          "type": ["integer", "null"],
          "minimum": 1,
          "description": "Archive after this many days"
        },
        "delete_after_days": {
          "type": ["integer", "null"],
          "minimum": 1,
          "description": "Delete after this many days"
        },
        "backup_required": {
          "type": ["boolean", "null"],
          "description": "Whether backup is required"
        }
      },
      "additionalProperties": false
    },
    "environment": {
      "type": ["string", "null"],
      "enum": ["development", "staging", "production", "testing"],
      "description": "Environment where features were computed"
    },
    "is_active": {
      "type": ["boolean", "null"],
      "default": true,
      "description": "Whether feature record is active"
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "Timestamp when record was created"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "Timestamp when record was last updated"
    },
    "expires_at": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "When this feature record expires"
    }
  },
  "additionalProperties": false,
  "allOf": [
    {
      "description": "Entity ID must reference valid entity based on type",
      "if": {
        "properties": {
          "entity_type": {"const": "equipment"}
        }
      },
      "then": {
        "properties": {
          "entity_id": {
            "description": "Must reference equipment_registry.id"
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "entity_type": {"const": "user"}
        }
      },
      "then": {
        "properties": {
          "entity_id": {
            "description": "Must reference users.id"
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "entity_type": {"const": "session"}
        }
      },
      "then": {
        "properties": {
          "entity_id": {
            "description": "Must reference diagnostic_sessions.session_id"
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "entity_type": {"const": "part"}
        }
      },
      "then": {
        "properties": {
          "entity_id": {
            "description": "Must reference parts_inventory.part_id"
          }
        }
      }
    },
    {
      "description": "Data quality scores must be normalized (0-1)",
      "if": {
        "properties": {
          "data_quality": {
            "properties": {
              "completeness_score": {"type": "number"}
            }
          }
        }
      },
      "then": {
        "properties": {
          "data_quality": {
            "properties": {
              "completeness_score": {
                "minimum": 0,
                "maximum": 1
              }
            }
          }
        }
      }
    },
    {
      "description": "Archive must be before delete",
      "if": {
        "properties": {
          "retention_policy": {
            "properties": {
              "archive_after_days": {"type": "integer"},
              "delete_after_days": {"type": "integer"}
            }
          }
        }
      },
      "then": {
        "properties": {
          "retention_policy": {
            "properties": {
              "archive_after_days": {"type": "integer"},
              "delete_after_days": {"type": "integer"}
            }
          }
        }
      }
    },
    {
      "description": "Feature count should match actual features",
      "if": {
        "properties": {
          "features": {"type": "object"},
          "feature_metadata": {
            "properties": {
              "feature_count": {"type": "integer"}
            }
          }
        }
      },
      "then": {
        "properties": {
          "feature_metadata": {
            "properties": {
              "feature_count": {
                "type": "integer"
              }
            }
          }
        }
      }
    }
  ]
}